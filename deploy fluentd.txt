{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "logs:PutLogEvents",
                "logs:CreateLogGroup",
                "logs:PutRetentionPolicy",
                "logs:CreateLogStream",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams"
            ],
            "Effect": "Allow",
            "Resource": "*"
        },
		{
		"Effect": "Allow",
		"Action": "ec2:Describe*",
		"Resource": "*"
		},
		{
		"Effect": "Allow",
		"Action": "elasticloadbalancing:Describe*",
		"Resource": "*"
		},
		{
		"Effect": "Allow",
		"Action": [
			"cloudwatch:ListMetrics",
			"cloudwatch:GetMetricStatistics",
			"cloudwatch:Describe*"
		],
		"Resource": "*"
		},
		{
		"Effect": "Allow",
		"Action": "autoscaling:Describe*",
		"Resource": "*"
		}
    ]
}


)))))


sudo curl -L https://toolbelt.treasuredata.com/sh/install-amazon2-td-agent4.sh | sh
sudo /opt/td-agent/bin/gem install fluent-plugin-cloudwatch-logs
sudo /opt/td-agent/bin/gem install fluent-plugin-ec2-metadata
sudo rm /etc/td-agent/td-agent.conf

sudo echo "

@include 

<source>
  @type tail
  path /home/ec2-user/*.log
  tag instance.log
  pos_file /var/log/td-agent/td-agent.log
  <parse>
  @type none
  </parse>
</source>

<filter instance.log>
  @type ec2_metadata

  metadata_refresh_seconds 3000
  imdsv2 true

  <record>
    hostname      ${tagset_name}
    instance_id   ${instance_id}
    instance_type ${instance_type}
    private_ip    ${private_ip}
    az            ${availability_zone}
    vpc_id        ${vpc_id}
    ami_id        ${image_id}
    account_id    ${account_id}
  </record>
</filter>

<match instance.log>
  @type cloudwatch_logs
  log_group_name staging-fluentd-apps-logs
  log_stream_name apps-logs
  auto_create_stream true 
  region eu-central-1
</match>

" > /etc/td-agent/td-agent.conf

sudo systemctl restart td-agent
